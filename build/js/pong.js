jQuery(function(t){var e=(function(){return requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||function(t){setTimeout(t,1e3/60)}}(),function(t,e){return Math.round(Math.random()*(e-t)+t)}),i=function(t){return t=t||.5,Math.random()<t},o={fieldWidth:2e3,fieldHeight:1e3,startTime:30,currentTime:null,score:0,scores:{left:4,right:4},ball:{},leftPlatform:{},rightPlatform:{},const:{platformVelocity:500},gameItems:[],getItem:function(t){var e=this;e.gameItems.forEach(function(e){if(e.name==t)return e})},resetGame:function(){this.ball={name:"ball",type:"ball",size:{x:50,y:50},position:{x:0,y:0},velocity:{x:1500,y:0},acceleration:{x:0,y:0}},this.leftPlatform={name:"leftPlatform",type:"platform",size:{x:20,y:200},position:{x:-990,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0}},this.rightPlatform={name:"rightPlatform",type:"platform",size:{x:17,y:200},position:{x:990,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0}},this.score=0,this.currentTime=this.startTime,this.gameItems=[this.ball,this.leftPlatform,this.rightPlatform]},tick:function(t){t=t||1e3/60;var e=this;e.playScene(t).mayBeBonus().countdown(t).scoreUp(t).checkCollisions(),s.play(),n.drawAllItems(e.gameItems),n.drawCounter(e.currentTime)},countdown:function(e){return this.currentTime-=e/1e3,this.currentTime<0&&(this.currentTime=0,t(document).trigger("gameover")),this},scoreUp:function(t){return this.score+=t/100,this},playScene:function(t){var e=this;return e.gameItems.forEach(function(e){e.position.x+=e.velocity.x*t/1e3,e.position.y+=e.velocity.y*t/1e3,e.velocity.x+=e.acceleration.x*t/1e3,e.velocity.y+=e.acceleration.y*t/1e3}),e},checkCollisions:function(){var t=this;return t.gameItems.forEach(function(e,i){var n=function(t,e){switch(t.type){case"ball":t.velocity[e]*=-1,"x"==e&&o.changeTime(5*(t.position.x<0?1:-1));break;case"platform":t.velocity[e]=0}};e.position.x+e.size.x/2>t.fieldWidth/2?(e.position.x=t.fieldWidth/2-e.size.x/2,n(e,"x")):e.position.x-e.size.x/2<-t.fieldWidth/2?(e.position.x=-t.fieldWidth/2+e.size.x/2,n(e,"x")):e.position.y+e.size.y/2>t.fieldHeight/2?(e.position.y=t.fieldHeight/2-e.size.y/2,n(e,"y")):e.position.y-e.size.y/2<-t.fieldHeight/2&&(e.position.y=-t.fieldHeight/2+e.size.y/2,n(e,"y"));for(var a=i+1;a<t.gameItems.length;a++){var s=t.gameItems[i],r=t.gameItems[a],l=null,c=null,u=null;if(s&&r){"ball"===s.type&&(l=t.gameItems[i]),"platform"===r.type&&(c=t.gameItems[a]),"bonus"===r.type&&(u=t.gameItems[a]);var m={x:Math.abs(s.position.x-r.position.x)-s.size.x/2-r.size.x/2,y:Math.abs(s.position.y-r.position.y)-s.size.y/2-r.size.y/2};if(m.x<0&&m.y<0){if(l&&c)if(m.y>=m.x)l.position.y<c.position.y?l.position.y=c.position.y-l.size.y/2-c.size.y/2:l.position.y=c.position.y+l.size.y/2+c.size.y/2,l.velocity.y*=-1,l.velocity.y+=c.velocity.y;else if(m.x>m.y){l.position.x<c.position.x?l.position.x=c.position.x-l.size.x/2-c.size.x/2:l.position.x=c.position.x+l.size.x/2+c.size.x/2;var y=(l.position.y-c.position.y)/c.size.y;l.velocity.y=y*Math.abs(l.velocity.x),l.velocity.x*=-1,l.velocity.x+=c.velocity.x}l&&u&&(delete t.gameItems[a],t.checkBonus(u))}}}}),t},mayBeBonus:function(){var t=this;return i(.007)&&!t.bonusFlag&&(t.createBonus(),t.bonusFlag=!0,setTimeout(function(){t.bonusFlag=!1},2e3)),t},checkBonus:function(t){var e=t.value;this.changeTime(e)},createBonus:function(){var t,i=e(1,5);t={type:"bonus",position:{x:e(-200,200),y:e(-200,200)},velocity:{x:0,y:0},acceleration:{x:0,y:0},size:{x:75,y:75},value:i},this.gameItems.push(t)},bonusFlag:null,platformUp:function(t){var e=this;e[t].velocity.y=-e.const.platformVelocity},platformDown:function(t){var e=this;e[t].velocity.y=e.const.platformVelocity},stopPlatform:function(t){var e=this;e[t].velocity.y=0},inPlay:!1,gameStarted:!1,startGame:function(){this.gameStarted=!0,this.currentTime=this.startTime,this.startRound()},startRound:function(){this.inPlay=!0,this.gameStep()},pauseGame:function(){this.inPlay=!1},restoreGame:function(){this.inPlay=!0,o.gameStep()},gameOver:function(){this.inPlay=!1,this.gameStarted=!1,n.drawCounter(this.currentTime),n.drawScore(Math.round(this.score))},gameRestart:function(){this.inPlay=!0,this.resetGame(),n.drawAllItems(this.gameItems).unDrawScore().drawCounter(this.currentTime)},changeTime:function(e){console.log(e),this.currentTime+=e,n.showChangedTime(e),this.currentTime<0&&(this.currentTime=0,t(document).trigger("gameover"))},restartGame:function(){this.resetGame(),n.drawAllItems(this.gameItems)},gameStep:function(){return o.inPlay&&o.currentTime>0&&(o.tick(),requestAnimationFrame(o.gameStep)),this},init:function(){this.resetGame(),this.gameItems=[this.ball,this.leftPlatform,this.rightPlatform],n.init(this.gameItems)}},n={message:{text:"",sense:null},gameField:"",gameCanvas:"",drawField:"",scoreWindowElement:t(".game-over"),countdownElement:t(".countdown"),canvasWidth:2e3,canvasHeight:1e3,drawItem:function(t){var e=this,i=t.type,o=t.position,n=t.size;switch(e.drawField.beginPath(),i){case"ball":var a={x:o.x+e.canvasWidth/2,y:o.y+e.canvasHeight/2};e.drawField.arc(a.x,a.y,n.x/2,0,2*Math.PI,!1);var s=e.drawField.createRadialGradient(a.x,a.y,0,a.x,a.y,n.x/2);s.addColorStop(0,"white"),s.addColorStop(.8,"white"),s.addColorStop(1,"rgba(255,255,255,.1)"),e.drawField.fillStyle=s;break;case"platform":e.drawField.rect(o.x+e.canvasWidth/2-n.x/2,o.y+e.canvasHeight/2-n.y/2,n.x,n.y),e.drawField.fillStyle="#fff";break;case"bonus":var a={x:o.x+e.canvasWidth/2,y:o.y+e.canvasHeight/2};e.drawField.arc(a.x,a.y,n.x/2,0,2*Math.PI,!1);var s=e.drawField.createRadialGradient(a.x,a.y,0,a.x,a.y,n.x/2);s.addColorStop(0,"rgba(55,255,55,.2)"),s.addColorStop(.8,"rgba(55,255,55,.2)"),s.addColorStop(1,"rgba(55,255,55,.9)"),e.drawField.font="50px Raleway",e.drawField.fillStyle="white",e.drawField.fillText(t.value,a.x-13,a.y+12),e.drawField.fillStyle=s}return e.drawField.fill(),this},drawScore:function(t){return this.scoreWindowElement.find(".score").text(t),this.scoreWindowElement.addClass("show"),this},unDrawScore:function(){return this.scoreWindowElement.removeClass("show"),this},drawCounter:function(t){t=Math.round(100*t)/100+"";var e=t.split(".");return e.length>1?1===e[1].length&&(t+=0):t+=".00",this.countdownElement.text(t),this},drawAllItems:function(t,e){var i=this;return i.drawField.clearRect(0,0,i.canvasWidth,i.canvasHeight),t.forEach(function(t){i.drawItem(t)}),i},showChangedTime:function(e){e>0&&(e="+"+e);var i=t("<span>"+e+"</span>"),o=e<0?"bad-message":"good-message";i.addClass("info-msg "+o),this.gameField.append(i),setTimeout(function(){i.addClass("run")},0),setTimeout(function(){i.remove()},1500)},init:function(e){var i=this;i.gameField=t("#pong-game-field"),i.gameCanvas=t('<canvas width="'+i.canvasWidth+'" height="'+i.canvasHeight+'"></canvas>'),i.gameField.append(i.gameCanvas),i.drawField=i.gameCanvas.get(0).getContext("2d"),i.drawAllItems(e)}},a={keysInPlay:{},startButton:function(){o.gameStarted?o.inPlay?o.pauseGame():o.restoreGame():o.startGame()},keyDownAction:function(t){switch(t){case 38:o.platformUp("rightPlatform");break;case 40:o.platformDown("rightPlatform");break;case 87:o.platformUp("leftPlatform");break;case 83:o.platformDown("leftPlatform")}},keyUpAction:function(t){switch(t){case 38:case 40:o.stopPlatform("rightPlatform");break;case 87:case 83:o.stopPlatform("leftPlatform")}},touchPlay:function(t){t>o.rightPlatform.position.y?(this.keysInPlay.touch=40,this.keyDownAction(40)):(this.keysInPlay.touch=38,this.keyDownAction(38))},touchEndPlay:function(){this.keysInPlay.touch&&this.keyUpAction(this.keysInPlay.touch)},gameOver:function(){o.gameOver()},gameRestart:function(){o.gameRestart()},bonusAdd:function(){console.log("bonusadded")}},s={watch:!0,watchTimer:!1,key:null,predictBallPosition:null,timeout:200,ball:o.ball,position:o.leftPlatform.position,calculateBallPosition:function(){var t=(o.ball.position.y+o.fieldHeight/2,Math.abs(o.ball.position.x-o.leftPlatform.position.x)-(o.leftPlatform.size.x/2+o.ball.size.x/2)),e=Math.abs(t/o.ball.velocity.x)*o.ball.velocity.y,i=o.ball.position.y+e;return{x:o.leftPlatform.position.x,y:i}},slide:function(t){var e,i,o,n=this;if("up"==t?o=87:"down"==t&&(o=83),n.key!=o){if(n.key){var e=new Event("keyup");e.keyCode=n.key,document.dispatchEvent(e),n.key=null}var i=new Event("keydown");i.keyCode=o,n.key=o,document.dispatchEvent(i)}},stop:function(){var t=this;if(t.key){var e=new Event("keyup");e.keyCode=t.key,t.key=null,t.predictBallPosition=null,document.dispatchEvent(e)}},play:function(){var t=this;return!!t.watch&&void(o.ball.velocity.x<0?(t.predictBallPosition=t.calculateBallPosition(),o.leftPlatform.position.y-t.predictBallPosition.y>50?setTimeout(function(){t.slide("up"),t.timeout=1},t.timeout):o.leftPlatform.position.y-t.predictBallPosition.y<-50&&setTimeout(function(){t.slide("down"),t.timeout=1},t.timeout)):(t.stop(),t.timeout=200))},setTimer:function(){}};!function(){var e={init:function(){this.main(),this.events()},main:function(){o.init()},events:function(){keysDown={};var e=function(t){32==t.keyCode&&(t.preventDefault(),a.startButton()),38!=t.keyCode&&40!=t.keyCode&&87!=t.keyCode&&83!=t.keyCode||(t.preventDefault(),keysDown[t.keyCode]||(keysDown[t.keyCode]=!0,a.keyDownAction(t.keyCode)))},i=function(t){38!=t.keyCode&&40!=t.keyCode&&87!=t.keyCode&&83!=t.keyCode||(t.preventDefault(),keysDown[t.keyCode]&&(keysDown[t.keyCode]=!1,a.keyUpAction(t.keyCode)))},n=function(t){32==t.keyCode&&(t.preventDefault(),a.startButton())},s=function(e){if(o.inPlay){e.preventDefault();var i=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],n=(i.pageY-t("canvas").offset().top)/t("canvas").outerHeight()*t("canvas").attr("height")-t("canvas").attr("height")/2;a.touchPlay(n)}},r=function(t){o.inPlay&&a.touchEndPlay()};t(document).on("keydown",e),t(document).on("keyup",i),t(document).on("keypress",n),t(document).on("click",".closeButton",a.gameRestart),t(document).on("touchstart","canvas",s),t(document).on("touchend",r),t(document).on("bonusadded",a.bonusAdd),t(document).on("gameover",a.gameOver)}};e.init()}()});