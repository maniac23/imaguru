var animationFrame=function(){return requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)}}(),getRandom=function(e,t){return Math.round(Math.random()*(t-e)+e)},probably=function(e){return e=e||.5,Math.random()<e},Model={fieldWidth:2e3,fieldHeight:1e3,startTime:30,currentTime:null,score:0,scores:{left:4,right:4},ball:{},leftPlatform:{},rightPlatform:{},const:{platformVelocity:500},gameItems:[],getItem:function(e){var t=this;t.gameItems.forEach(function(t){if(t.name==e)return t})},resetGame:function(){this.ball={name:"ball",type:"ball",size:{x:50,y:50},position:{x:0,y:0},velocity:{x:1500,y:0},acceleration:{x:0,y:0}},this.leftPlatform={name:"leftPlatform",type:"platform",size:{x:20,y:200},position:{x:-990,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0}},this.rightPlatform={name:"rightPlatform",type:"platform",size:{x:17,y:200},position:{x:990,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0}},this.score=0,this.currentTime=this.startTime,this.gameItems=[this.ball,this.leftPlatform,this.rightPlatform]},tick:function(e){e=e||1e3/60;var t=this;t.playScene(e).mayBeBonus().countdown(e).scoreUp(e).checkCollisions(),AI.play(),View.drawAllItems(t.gameItems),View.drawCounter(t.currentTime)},countdown:function(e){return this.currentTime-=e/1e3,this.currentTime<0&&(this.currentTime=0,$(document).trigger("gameover")),this},scoreUp:function(e){return this.score+=e/100,this},playScene:function(e){var t=this;return t.gameItems.forEach(function(t){t.position.x+=t.velocity.x*e/1e3,t.position.y+=t.velocity.y*e/1e3,t.velocity.x+=t.acceleration.x*e/1e3,t.velocity.y+=t.acceleration.y*e/1e3}),t},checkCollisions:function(){var e=this;return e.gameItems.forEach(function(t,o){var i=function(e,t){switch(e.type){case"ball":e.velocity[t]*=-1,"x"==t&&Model.changeTime(5*(e.position.x<0?1:-1));break;case"platform":e.velocity[t]=0}};t.position.x+t.size.x/2>e.fieldWidth/2?(t.position.x=e.fieldWidth/2-t.size.x/2,i(t,"x")):t.position.x-t.size.x/2<-e.fieldWidth/2?(t.position.x=-e.fieldWidth/2+t.size.x/2,i(t,"x")):t.position.y+t.size.y/2>e.fieldHeight/2?(t.position.y=e.fieldHeight/2-t.size.y/2,i(t,"y")):t.position.y-t.size.y/2<-e.fieldHeight/2&&(t.position.y=-e.fieldHeight/2+t.size.y/2,i(t,"y"));for(var n=o+1;n<e.gameItems.length;n++){var a=e.gameItems[o],l=e.gameItems[n],s=null,r=null,c=null;if(a&&l){"ball"===a.type&&(s=e.gameItems[o]),"platform"===l.type&&(r=e.gameItems[n]),"bonus"===l.type&&(c=e.gameItems[n]);var d={x:Math.abs(a.position.x-l.position.x)-a.size.x/2-l.size.x/2,y:Math.abs(a.position.y-l.position.y)-a.size.y/2-l.size.y/2};if(d.x<0&&d.y<0){if(s&&r)if(d.y>=d.x)s.position.y<r.position.y?s.position.y=r.position.y-s.size.y/2-r.size.y/2:s.position.y=r.position.y+s.size.y/2+r.size.y/2,s.velocity.y*=-1,s.velocity.y+=r.velocity.y;else if(d.x>d.y){s.position.x<r.position.x?s.position.x=r.position.x-s.size.x/2-r.size.x/2:s.position.x=r.position.x+s.size.x/2+r.size.x/2;var m=(s.position.y-r.position.y)/r.size.y;s.velocity.y=m*Math.abs(s.velocity.x),s.velocity.x*=-1,s.velocity.x+=r.velocity.x}s&&c&&(delete e.gameItems[n],e.checkBonus(c))}}}}),e},mayBeBonus:function(){var e=this;return probably(.007)&&!e.bonusFlag&&(e.createBonus(),e.bonusFlag=!0,setTimeout(function(){e.bonusFlag=!1},2e3)),e},checkBonus:function(e){var t=e.value;this.changeTime(t)},createBonus:function(){var e,t=getRandom(1,5);e={type:"bonus",position:{x:getRandom(-200,200),y:getRandom(-200,200)},velocity:{x:0,y:0},acceleration:{x:0,y:0},size:{x:75,y:75},value:t},this.gameItems.push(e)},bonusFlag:null,platformUp:function(e){var t=this;t[e].velocity.y=-t.const.platformVelocity},platformDown:function(e){var t=this;t[e].velocity.y=t.const.platformVelocity},stopPlatform:function(e){var t=this;t[e].velocity.y=0},inPlay:!1,gameStarted:!1,startGame:function(){this.gameStarted=!0,this.currentTime=this.startTime,this.startRound()},startRound:function(){this.inPlay=!0,this.gameStep()},pauseGame:function(){this.inPlay=!1},restoreGame:function(){this.inPlay=!0,Model.gameStep()},gameOver:function(){this.inPlay=!1,this.gameStarted=!1,View.drawCounter(this.currentTime),View.drawScore(Math.round(this.score))},gameRestart:function(){this.inPlay=!0,this.resetGame(),View.drawAllItems(this.gameItems).unDrawScore().drawCounter(this.currentTime)},changeTime:function(e){console.log(e),this.currentTime+=e,View.showChangedTime(e),this.currentTime<0&&(this.currentTime=0,$(document).trigger("gameover"))},restartGame:function(){this.resetGame(),View.drawAllItems(this.gameItems)},gameStep:function(){return Model.inPlay&&Model.currentTime>0&&(Model.tick(),requestAnimationFrame(Model.gameStep)),this},init:function(){this.resetGame(),this.gameItems=[this.ball,this.leftPlatform,this.rightPlatform],View.init(this.gameItems)}},View={message:{text:"",sense:null},gameField:"",gameCanvas:"",drawField:"",scoreWindowElement:$(".game-over"),countdownElement:$(".countdown"),canvasWidth:2e3,canvasHeight:1e3,drawItem:function(e){var t=this,o=e.type,i=e.position,n=e.size;switch(t.drawField.beginPath(),o){case"ball":var a={x:i.x+t.canvasWidth/2,y:i.y+t.canvasHeight/2};t.drawField.arc(a.x,a.y,n.x/2,0,2*Math.PI,!1);var l=t.drawField.createRadialGradient(a.x,a.y,0,a.x,a.y,n.x/2);l.addColorStop(0,"white"),l.addColorStop(.8,"white"),l.addColorStop(1,"rgba(255,255,255,.1)"),t.drawField.fillStyle=l;break;case"platform":t.drawField.rect(i.x+t.canvasWidth/2-n.x/2,i.y+t.canvasHeight/2-n.y/2,n.x,n.y),t.drawField.fillStyle="#fff";break;case"bonus":var a={x:i.x+t.canvasWidth/2,y:i.y+t.canvasHeight/2};t.drawField.arc(a.x,a.y,n.x/2,0,2*Math.PI,!1);var l=t.drawField.createRadialGradient(a.x,a.y,0,a.x,a.y,n.x/2);l.addColorStop(0,"rgba(55,255,55,.2)"),l.addColorStop(.8,"rgba(55,255,55,.2)"),l.addColorStop(1,"rgba(55,255,55,.9)"),t.drawField.font="50px Raleway",t.drawField.fillStyle="white",t.drawField.fillText(e.value,a.x-13,a.y+12),t.drawField.fillStyle=l}return t.drawField.fill(),this},drawScore:function(e){return this.scoreWindowElement.find(".score").text(e),this.scoreWindowElement.addClass("show"),this},unDrawScore:function(){return this.scoreWindowElement.removeClass("show"),this},drawCounter:function(e){e=Math.round(100*e)/100+"";var t=e.split(".");return t.length>1?1===t[1].length&&(e+=0):e+=".00",this.countdownElement.text(e),this},drawAllItems:function(e,t){var o=this;return o.drawField.clearRect(0,0,o.canvasWidth,o.canvasHeight),e.forEach(function(e){o.drawItem(e)}),o},showChangedTime:function(e){e>0&&(e="+"+e);var t=$("<span>"+e+"</span>"),o=e<0?"bad-message":"good-message";t.addClass("info-msg "+o),this.gameField.append(t),setTimeout(function(){t.addClass("run")},0),setTimeout(function(){t.remove()},1500)},init:function(e){var t=this;t.gameField=$("#pong-game-field"),t.gameCanvas=$('<canvas width="'+t.canvasWidth+'" height="'+t.canvasHeight+'"></canvas>'),t.gameField.append(t.gameCanvas),t.drawField=t.gameCanvas.get(0).getContext("2d"),t.drawAllItems(e)}},Controller={keysInPlay:{},startButton:function(){Model.gameStarted?Model.inPlay?Model.pauseGame():Model.restoreGame():Model.startGame()},keyDownAction:function(e){switch(e){case 38:Model.platformUp("rightPlatform");break;case 40:Model.platformDown("rightPlatform");break;case 87:Model.platformUp("leftPlatform");break;case 83:Model.platformDown("leftPlatform")}},keyUpAction:function(e){switch(e){case 38:case 40:Model.stopPlatform("rightPlatform");break;case 87:case 83:Model.stopPlatform("leftPlatform")}},touchPlay:function(e){e>Model.rightPlatform.position.y?(this.keysInPlay.touch=40,this.keyDownAction(40)):(this.keysInPlay.touch=38,this.keyDownAction(38))},touchEndPlay:function(){this.keysInPlay.touch&&this.keyUpAction(this.keysInPlay.touch)},gameOver:function(){Model.gameOver()},gameRestart:function(){Model.gameRestart()},bonusAdd:function(){console.log("bonusadded")}},AI={watch:!0,watchTimer:!1,key:null,predictBallPosition:null,timeout:200,ball:Model.ball,position:Model.leftPlatform.position,calculateBallPosition:function(){var e=(Model.ball.position.y+Model.fieldHeight/2,Math.abs(Model.ball.position.x-Model.leftPlatform.position.x)-(Model.leftPlatform.size.x/2+Model.ball.size.x/2)),t=Math.abs(e/Model.ball.velocity.x)*Model.ball.velocity.y,o=Model.ball.position.y+t;return{x:Model.leftPlatform.position.x,y:o}},slide:function(e){var t,o,i,n=this;if("up"==e?i=87:"down"==e&&(i=83),n.key!=i){if(n.key){var t=new Event("keyup");t.keyCode=n.key,document.dispatchEvent(t),n.key=null}var o=new Event("keydown");o.keyCode=i,n.key=i,document.dispatchEvent(o)}},stop:function(){var e=this;if(e.key){var t=new Event("keyup");t.keyCode=e.key,e.key=null,e.predictBallPosition=null,document.dispatchEvent(t)}},play:function(){var e=this;return!!e.watch&&void(Model.ball.velocity.x<0?(e.predictBallPosition=e.calculateBallPosition(),Model.leftPlatform.position.y-e.predictBallPosition.y>50?setTimeout(function(){e.slide("up"),e.timeout=1},e.timeout):Model.leftPlatform.position.y-e.predictBallPosition.y<-50&&setTimeout(function(){e.slide("down"),e.timeout=1},e.timeout)):(e.stop(),e.timeout=200))},setTimer:function(){}};!function(){var e={init:function(){this.main(),this.events()},main:function(){Model.init()},events:function(){keysDown={};var e=function(e){32==e.keyCode&&(e.preventDefault(),Controller.startButton()),38!=e.keyCode&&40!=e.keyCode&&87!=e.keyCode&&83!=e.keyCode||(e.preventDefault(),keysDown[e.keyCode]||(keysDown[e.keyCode]=!0,Controller.keyDownAction(e.keyCode)))},t=function(e){38!=e.keyCode&&40!=e.keyCode&&87!=e.keyCode&&83!=e.keyCode||(e.preventDefault(),keysDown[e.keyCode]&&(keysDown[e.keyCode]=!1,Controller.keyUpAction(e.keyCode)))},o=function(e){32==e.keyCode&&(e.preventDefault(),Controller.startButton())},i=function(e){if(Model.inPlay){e.preventDefault();var t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],o=(t.pageY-$("canvas").offset().top)/$("canvas").outerHeight()*$("canvas").attr("height")-$("canvas").attr("height")/2;Controller.touchPlay(o)}},n=function(e){Model.inPlay&&Controller.touchEndPlay()};$(document).on("keydown",e),$(document).on("keyup",t),$(document).on("keypress",o),$(document).on("click",".closeButton",Controller.gameRestart),$(document).on("touchstart","canvas",i),$(document).on("touchend",n),$(document).on("bonusadded",Controller.bonusAdd),$(document).on("gameover",Controller.gameOver)}};e.init()}();